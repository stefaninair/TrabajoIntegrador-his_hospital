extends ../layout

block content
  // Main container with margin and a Bootstrap card for design
  .container.my-5
    .card.shadow-lg.mx-auto.border-0.rounded-4(style="max-width: 800px;")
      .card-header.bg-gradient.bg-warning.text-white.text-center.py-4.rounded-top-4
        h1.mb-0.display-5 Verificar Datos

      .card-body.p-5
        // Formulario de edici√≥n
        form#formPaciente(action="/pacientes/editar/" + paciente.id, method="POST", novalidate)
          .row.g-3 

            // DNI Field - AHORA SOLO LECTURA
            .col-12.col-md-6.form-floating
              input.form-control(
                type='text',
                name='dni',
                id='dni',
                placeholder='DNI',
                value=paciente.dni || '',
                required,
                readonly, 
                class=(errores && errores.dni ? 'is-invalid' : '')
              )
              label(for='dni') DNI
              if errores && errores.dni
                .invalid-feedback= errores.dni

            // Fecha de nacimiento Field
            .col-12.col-md-6.form-floating
              input.form-control(
                type='date',
                name='fecha_nacimiento',
                id='fecha_nacimiento',
                placeholder='Fecha de nacimiento',
                value=paciente.fecha_nacimiento ? paciente.fecha_nacimiento.toISOString().substring(0, 10) : '',
                required,
                class=(errores && errores.fecha_nacimiento ? 'is-invalid' : '')
              )
              label(for='fecha_nacimiento') Fecha de nacimiento
              if errores && errores.fecha_nacimiento
                .invalid-feedback= errores.fecha_nacimiento

            // Nombre Field
            .col-md-6.form-floating
              input.form-control(
                type='text',
                name='nombre',
                id='nombre',
                placeholder='Nombre',
                value=paciente.nombre || '',
                required,
                class=(errores && errores.nombre ? 'is-invalid' : '')
              )
              label(for='nombre') Nombre
              if errores && errores.nombre
                .invalid-feedback= errores.nombre

            // Apellido Field
            .col-md-6.form-floating
              input.form-control(
                type='text',
                name='apellido',
                id='apellido',
                placeholder='Apellido',
                value=paciente.apellido || '',
                required,
                class=(errores && errores.apellido ? 'is-invalid' : '')
              )
              label(for='apellido') Apellido
              if errores && errores.apellido
                .invalid-feedback= errores.apellido
            
            // Correo electr√≥nico Field
            .col-md-6.form-floating
              input.form-control(
                type='email',
                name='correo',
                id='correo',
                placeholder='Correo electr√≥nico',
                value=paciente.correo || '',
                class=(errores && errores.correo ? 'is-invalid' : '')
              )
              label(for='correo') Correo electr√≥nico
              if errores && errores.correo
                .invalid-feedback= errores.correo

            // Direcci√≥n Field
            .col-md-6.form-floating
              input.form-control(
                type='text',
                name='direccion',
                id='direccion',
                placeholder='Direcci√≥n',
                value=paciente.direccion || ''
              )
              label(for='direccion') Direcci√≥n

            // Tel√©fono Field
            .col-md-6.form-floating
              input.form-control(
                type='text',
                name='telefono',
                id='telefono',
                placeholder='Tel√©fono',
                value=paciente.telefono || ''
              )
              label(for='telefono') Tel√©fono

            // G√©nero Field
            .col-md-6
              label.form-label(for='sexo').text-white G√©nero:
              select.form-select(
                name='sexo',
                id='sexo',
                required,
                class=(errores && errores.sexo ? 'is-invalid' : '')
              )
                option(value='') Seleccionar...
                option(value='M', selected=paciente.sexo==='M') Masculino
                option(value='F', selected=paciente.sexo==='F') Femenino
              if errores && errores.sexo
                .invalid-feedback= errores.sexo

            // Seguro M√©dico Field (Obligatorio)
            .col-md-6
              label.form-label(for='id_seguro').text-white Seguro M√©dico:
              select.form-select(
                name='id_seguro',
                id='id_seguro',
                required,
                class=(errores && errores.id_seguro ? 'is-invalid' : '')
              )
                option(value='') Seleccionar...
                each seguro in seguros
                  option(value=seguro.id, selected=paciente.id_seguro==seguro.id)= seguro.nombre
              if errores && errores.id_seguro
                .invalid-feedback= errores.id_seguro

            // N√∫mero de Afiliado Field (Validaci√≥n condicional en JS/Backend)
            .col-md-6.form-floating
              input.form-control(
                type='text',
                name='nro_afiliado',
                id='nro_afiliado',
                placeholder='N√∫mero de Afiliado',
                value=paciente.nro_afiliado || ''
              )
              label(for='nro_afiliado') N√∫mero de Afiliado
              if errores && errores.nro_afiliado
                .invalid-feedback= errores.nro_afiliado

          // Messages (Success/Error)
          if mensajeExito
            .alert.alert-success.mt-4.text-center= mensajeExito
          if errores && Object.keys(errores).length > 0 && !errores.general
            .alert.alert-danger.mt-4
              ul.mb-0
                each val, key in errores
                  li= val
          if errores && errores.general
            .alert.alert-danger.mt-4.text-center= errores.general


          // Buttons section para GUARDAR (dentro del formulario de edici√≥n)
          .d-flex.justify-content-center.gap-3.pt-4.mt-4.border-top
            a(href='/pacientes').btn.btn-secondary.btn-lg.rounded-pill
              i.bi.bi-arrow-left-circle.me-2
              | Volver
            button(type='submit').btn.btn-warning.btn-lg.rounded-pill.text-white ‚úèÔ∏è Actualizar Paciente
            a(href='/internaciones/nueva/' + paciente.id).btn.btn-success.btn-lg.rounded-pill.text-white.shadow-sm
              i.bi.bi-check-circle-fill.me-2
              | Confirmar Datos

        // Formulario de ELIMINAR (fuera del formulario de edici√≥n)
        form#formEliminarPaciente(action="/pacientes/eliminar/" + paciente.id, method="POST", class="mt-4 text-center")
          // Agrega un campo oculto para el DNI si quieres pasarlo al backend para el mensaje de error
          input(type="hidden", name="dni", value=paciente.dni) 
          button(type='submit').btn.btn-danger.btn-lg.rounded-pill(onclick="return confirm('¬øEst√°s seguro de que quieres eliminar a ' + '#{paciente.nombre}' + ' ' + '#{paciente.apellido}' + '? Esta acci√≥n es irreversible.');") üóëÔ∏è Eliminar Paciente


  // Client-side validation script (adaptado para edici√≥n)
  script.
    (function () {
      'use strict'

      const form = document.getElementById('formPaciente');
      const idSeguroInput = document.getElementById('id_seguro');
      const nroAfiliadoInput = document.getElementById('nro_afiliado');

      function clearNroAfiliadoValidation() {
          nroAfiliadoInput.classList.remove('is-invalid', 'is-valid');
          const existingFeedback = nroAfiliadoInput.parentNode.querySelector('.invalid-feedback');
          if (existingFeedback) {
              existingFeedback.remove();
          }
      }

      idSeguroInput.addEventListener('change', function() {
          clearNroAfiliadoValidation();
          validateNroAfiliado();
      });

      nroAfiliadoInput.addEventListener('input', function() {
          clearNroAfiliadoValidation();
          validateNroAfiliado();
      });

      function validateNroAfiliado() {
          const selectedSeguroId = idSeguroInput.value;
          const nroAfiliadoValue = nroAfiliadoInput.value.trim();
          
          // IMPORTANTE: AJUSTA ESTE VALOR AL ID REAL de 'Particular' en tu base de datos
          // Si tu seguro 'Particular' tiene un ID diferente a '1', c√°mbialo aqu√≠.
          const PARTICULAR_ID = '1'; 

          if (selectedSeguroId && selectedSeguroId !== '' && selectedSeguroId !== PARTICULAR_ID) {
              if (!nroAfiliadoValue) {
                  nroAfiliadoInput.classList.add('is-invalid');
                  let feedbackDiv = nroAfiliadoInput.parentNode.querySelector('.invalid-feedback');
                  if (!feedbackDiv) {
                      feedbackDiv = document.createElement('div');
                      feedbackDiv.classList.add('invalid-feedback');
                      nroAfiliadoInput.parentNode.appendChild(feedbackDiv);
                  }
                  feedbackDiv.textContent = 'El n√∫mero de afiliado es obligatorio para este seguro.';
                  return false;
              } else if (!/^\d{6}$/.test(nroAfiliadoValue)) { // <--- Validaci√≥n de 6 n√∫meros
                  nroAfiliadoInput.classList.add('is-invalid');
                  let feedbackDiv = nroAfiliadoInput.parentNode.querySelector('.invalid-feedback');
                  if (!feedbackDiv) {
                      feedbackDiv = document.createElement('div');
                      feedbackDiv.classList.add('invalid-feedback');
                      nroAfiliadoInput.parentNode.appendChild(feedbackDiv);
                  }
                  feedbackDiv.textContent = 'El n√∫mero de afiliado debe contener exactamente 6 n√∫meros.';
                  return false;
              } else {
                  nroAfiliadoInput.classList.add('is-valid'); 
              }
          } else {
              // Si el seguro es 'Particular' o no seleccionado, no se requiere el n√∫mero de afiliado
              clearNroAfiliadoValidation();
          }
          return true;
      }

      form.addEventListener('submit', function (event) {
        let formIsValid = form.checkValidity();
        let nroAfiliadoIsValid = validateNroAfiliado();

        if (!formIsValid || !nroAfiliadoIsValid) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false)

      document.addEventListener('DOMContentLoaded', function() {
          validateNroAfiliado();
          // Aseg√∫rate de que el formulario se marque como validado al cargar si hay errores
          if (document.querySelectorAll('.is-invalid').length > 0) {
              form.classList.add('was-validated');
          }
      });
    })()
    